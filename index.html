<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Theo Dõi Posts Elon Musk</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="date"] {
            padding: 8px;
            margin-bottom: 10px;
            width: 200px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            flex: 1;
            margin: 0 5px;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 0.8em;
            color: #6c757d;
        }
        .chart-section {
            margin-bottom: 40px;
        }
        .chart-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
        }
        #lineChartContainer, #heatChartContainer {
            position: relative;
            height: 400px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .debug {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard Theo Dõi Posts Elon Musk</h1>
        
        <div class="note">
            <strong>Lưu ý:</strong> Sử dụng proxy CORS miễn phí (codetabs.com) để tránh lỗi CORS. Nếu gặp 403, thử refresh hoặc thay proxy. Heatmap tổng hợp mật độ từ dữ liệu thực tế (nên có dữ liệu xanh ở hàng Sun/Thu/Fri/Sat, giờ 13-20 UTC).
        </div>
        
        <div class="controls">
            <label for="startDate">Ngày bắt đầu (YYYY-MM-DD):</label>
            <input type="date" id="startDate" value="2026-01-01">
            
            <label for="endDate">Ngày kết thúc (YYYY-MM-DD):</label>
            <input type="date" id="endDate" value="2026-01-05">
            
            <button onclick="loadData()">Tải Dữ Liệu</button>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div class="debug" id="debug" style="display: none;"></div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-number" id="totalPosts">0</div>
                <div class="stat-label">Tổng Số Posts</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgPosts">0</div>
                <div class="stat-label">TB Posts/Ngày</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="heatPosts">0</div>
                <div class="stat-label">Posts in Heatmap</div>
            </div>
        </div>
        
        <div class="chart-section">
            <div class="chart-title">Số Lượng Posts Hàng Ngày</div>
            <div id="lineChartContainer">
                <canvas id="postsChart"></canvas>
            </div>
        </div>
        
        <div class="chart-section">
            <div class="chart-title">Mật Độ Đăng Bài Theo Thời Gian (Heatmap - Giờ UTC & Ngày Trong Tuần)</div>
            <div id="heatChartContainer">
                <canvas id="heatChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let lineChart = null;
        let heatChart = null;
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Đăng ký Matrix controller sau khi load plugin
        if (typeof Chart !== 'undefined' && Chart.register) {
            const { MatrixController, MatrixElement } = window['chartjs-chart-matrix'];
            Chart.register(MatrixController, MatrixElement);
        }

        async function loadData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showError('Vui lòng chọn ngày bắt đầu và kết thúc.');
                return;
            }

            // Chuyển đổi sang định dạng ISO cho API
            const startIso = `${startDate}T17:00:00.000Z`;
            const endIso = `${endDate}T17:00:59.000Z`;
            
            const url = `https://xtracker.polymarket.com/api/users/elonmusk/posts?startDate=${startIso}&endDate=${endIso}`;
            
            // Sử dụng CORS proxy codetabs.com để tránh lỗi CORS
            const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;
            
            try {
                showError(''); // Xóa lỗi cũ
                document.getElementById('stats').style.display = 'none';
                document.getElementById('debug').style.display = 'none';
                
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                
                // API có thể không có "success", chỉ "data"
                const data = result.data || result || [];
                if (data.length === 0) {
                    throw new Error('Không có dữ liệu posts trong khoảng thời gian này.');
                }
                
                processData(data, startDate, endDate);
                
            } catch (error) {
                console.error('Lỗi chi tiết:', error);
                showError(`Lỗi khi tải dữ liệu: ${error.message}. Kiểm tra console để xem thêm. Nếu 403, thử proxy khác.`);
            }
        }

        function processData(posts, startStr, endStr) {
            // Group posts by day (YYYY-MM-DD) cho line chart
            const dailyCounts = {};
            posts.forEach(post => {
                const date = new Date(post.createdAt);
                const dayKey = date.toISOString().split('T')[0]; // YYYY-MM-DD
                dailyCounts[dayKey] = (dailyCounts[dayKey] || 0) + 1;
            });

            // Tạo danh sách ngày từ start đến end
            const start = new Date(startStr);
            const end = new Date(endStr);
            const days = [];
            const counts = [];
            let current = new Date(start);
            while (current <= end) {
                const dayKey = current.toISOString().split('T')[0];
                days.push(dayKey);
                counts.push(dailyCounts[dayKey] || 0);
                current.setDate(current.getDate() + 1);
            }

            // Tính tổng và trung bình
            const totalPosts = posts.length;
            const numDays = days.length;
            const avgPosts = numDays > 0 ? (totalPosts / numDays).toFixed(2) : 0;

            // Cập nhật stats
            document.getElementById('totalPosts').textContent = totalPosts;
            document.getElementById('avgPosts').textContent = avgPosts;

            // Vẽ line chart
            renderLineChart(days, counts);

            // Xử lý heatmap: ma trận 7x24 (weekday x hour)
            const matrix = Array.from({length: 7}, () => Array(24).fill(0));
            let validHeatPosts = 0;
            if (posts.length > 0) {
                const firstDate = new Date(posts[0].createdAt);
                const debugInfo = `First post: ${posts[0].createdAt}<br>Parsed: ${firstDate.toISOString()}<br>Hour: ${firstDate.getUTCHours()}, Weekday: ${firstDate.getUTCDay()} (${weekdays[firstDate.getUTCDay()]})`;
                document.getElementById('debug').innerHTML = `<strong>Debug Info:</strong><br>${debugInfo}`;
                document.getElementById('debug').style.display = 'block';
            }
            posts.forEach(post => {
                const date = new Date(post.createdAt);
                if (isNaN(date.getTime())) return;
                const hour = date.getUTCHours();
                const weekday = date.getUTCDay();
                if (!isNaN(hour) && hour >= 0 && hour < 24 && !isNaN(weekday) && weekday >= 0 && weekday < 7) {
                    matrix[weekday][hour]++;
                    validHeatPosts++;
                }
            });

            // Tính tổng posts in heatmap để debug
            document.getElementById('heatPosts').textContent = validHeatPosts;
            document.getElementById('stats').style.display = 'flex';

            console.log('Valid heat posts:', validHeatPosts, 'Total posts:', totalPosts);

            // Chuyển ma trận thành data cho matrix chart
            const heatData = [];
            let maxValue = 0;
            for (let y = 0; y < 7; y++) {
                for (let x = 0; x < 24; x++) {
                    const value = matrix[y][x] || 0;
                    heatData.push({ x, y, v: value });
                    if (value > maxValue) maxValue = value;
                }
            }
            console.log('Max value in matrix:', maxValue);

            // Vẽ heatmap
            renderHeatChart(heatData, maxValue);
        }

        function renderLineChart(labels, data) {
            const ctx = document.getElementById('postsChart').getContext('2d');
            
            if (lineChart) {
                lineChart.destroy();
            }
            
            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số Lượng Posts Hàng Ngày',
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderHeatChart(data, maxValue) {
            const ctx = document.getElementById('heatChart').getContext('2d');
            
            if (heatChart) {
                heatChart.destroy();
            }
            
            heatChart = new Chart(ctx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: 'Mật Độ Posts',
                        data: data,
                        width: ({chart}) => (chart.chartArea || {}).width / 24,
                        height: ({chart}) => (chart.chartArea || {}).height / 7,
                        backgroundColor: context => {
                            const val = context.parsed.v || 0;
                            if (val === 0) {
                                return 'rgba(0, 0, 0, 0)';
                            }
                            const alpha = Math.min(1, val / Math.max(maxValue, 1));
                            return `rgba(54, 162, 235, ${alpha})`;
                        },
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 0.5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: context => {
                                    const parsed = context[0].parsed;
                                    const y = parsed.y || 0;
                                    const x = parsed.x || 0;
                                    return `${weekdays[y]} - ${x}:00 UTC`;
                                },
                                label: context => {
                                    const val = context.parsed.v || 0;
                                    return `${val} posts`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            min: 0,
                            max: 23,
                            ticks: {
                                stepSize: 2,
                                callback: value => {
                                    if (value === 0) return '12am';
                                    if (value < 12) return `${value}am`;
                                    if (value === 12) return '12pm';
                                    return `${value - 12}pm`;
                                }
                            },
                            title: { display: true, text: 'Giờ (UTC)' }
                        },
                        y: {
                            type: 'linear',
                            min: 0,
                            max: 6,
                            ticks: {
                                callback: value => weekdays[value || 0]
                            },
                            title: { display: true, text: 'Ngày Trong Tuần' },
                            reverse: true  // Reverse để Sun ở dưới, Sat ở trên? Wait, default is y=0 bottom Sun, y=6 top Sat. To match X style (Sun bottom? ), but screenshot has Sun bottom.
                        }
                    }
                }
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = message ? 'block' : 'none';
        }

        // Tải dữ liệu mặc định khi load trang
        window.onload = () => loadData();
    </script>
</body>
</html>
